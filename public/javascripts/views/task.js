// Generated by CoffeeScript 1.7.1
(function() {
  define(["jquery", "underscore", "backbone", "vent", "views/comment", "collections/tasks", "text!templates/tasks/task.hbs", "handlebars"], function($, _, Backbone, Vent, CommentView, taskCollection, taskTemplate, Handlebars) {
    var task;
    task = Backbone.View.extend({
      initialize: function() {},
      tagName: 'li',
      className: 'list-group-item',
      events: {
        'click .btn.commentAdd': 'addComment',
        'click .btn.editTask': 'editTask',
        'click .btn.archiveTask': 'archiveTask',
        'click .btn.removeTask': 'removeTask'
      },
      template: Handlebars.compile(taskTemplate),
      render: function() {
        this.$el.html(this.template(this.model.toJSON()));
        return this;
      },
      addComment: function(e) {
        var comment, comments;
        e.preventDefault();
        comments = this.model.get('comments');
        comment = {
          comment: $(e.currentTarget).parent().find('.commentTextarea').val(),
          by: 'John Doe',
          created_at: new Date()
        };
        comments.push(comment);
        this.model.set({
          comments: comments
        });
        return this.model.save({
          wait: true
        }, {
          success: (function(_this) {
            return function(model) {
              var comm;
              $(e.currentTarget).parent().find('.commentTextarea').val('');
              comm = new CommentView({
                comment: comment
              });
              _this.$el.find('.commentWrapper .comment').append(comm.render().el);
              return _this.$el.find('span.badge').text(_this.model.get('comments').length);
            };
          })(this)
        });
      },
      archiveTask: function(e) {
        e.preventDefault();
        this.model.set({
          archive: true
        });
        return this.model.save({
          wait: true
        }, {
          success: (function(_this) {
            return function(model) {
              return _this.closeUpOption();
            };
          })(this)
        });
      },
      removeTask: function(e) {
        e.preventDefault();
        if (!confirm("Are you sure?")) {
          return;
        }
        this.model.destroy({
          wait: true
        });
        return this.closeUpOption();
      },
      editTask: function() {
        return Vent.trigger("task:edit", this.model);
      },
      closeUpOption: function() {
        this.$el.find('.commentWrapper').slideUp();
        return this.$el.find('.commentWrapper').parent().fadeOut();
      }
    });
    return task;
  });

}).call(this);
